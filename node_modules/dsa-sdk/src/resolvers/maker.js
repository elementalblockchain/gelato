var colInfo = {
  "ETH-A": {
    token: "ETH",
    ratio: 2 / 3,
    joinAddr: "0x2F0b23f53734252Bda2277357e97e1517d6B042A",
    addr: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4554482d41000000000000000000000000000000000000000000000000000000",
  },
  "ETH-B": {
    token: "ETH",
    ratio: 10 / 13,
    joinAddr: "0x08638eF1A205bE6762A8b935F5da9b700Cf7322c",
    addr: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4554482d42000000000000000000000000000000000000000000000000000000",
  },
  "BAT-A": {
    token: "BAT",
    ratio: 2 / 3,
    joinAddr: "0x3D0B1912B66114d4096F48A8CEe3A56C231772cA",
    addr: "0x0d8775f648430679a709e98d2b0cb6250d2887ef",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4241542d41000000000000000000000000000000000000000000000000000000",
  },
  "USDC-A": {
    token: "USDC",
    ratio: 10 / 11,
    joinAddr: "0xa191e578a6736167326d05c119ce0c90849e84b7",
    addr: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x555344432d410000000000000000000000000000000000000000000000000000",
  },
  "WBTC-A": {
    token: "WBTC",
    ratio: 2 / 3,
    joinAddr: "0xBF72Da2Bd84c5170618Fbe5914B0ECA9638d5eb5",
    addr: "0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x574254432d410000000000000000000000000000000000000000000000000000",
  },
  "USDC-B": {
    token: "USDC",
    ratio: 5 / 6,
    joinAddr: "0x2600004fd1585f7270756DDc88aD9cfA10dD0428",
    addr: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x555344432d420000000000000000000000000000000000000000000000000000",
  },
  "ZRX-A": {
    token: "ZRX",
    ratio: 4 / 7,
    joinAddr: "0xc7e8Cd72BDEe38865b4F5615956eF47ce1a7e5D0",
    addr: "0xE41d2489571d322189246DaFA5ebDe1F4699F498",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x5a52582d41000000000000000000000000000000000000000000000000000000",
  },
  "KNC-A": {
    token: "KNC",
    ratio: 4 / 7,
    joinAddr: "0x475F1a89C1ED844A08E8f6C50A00228b5E59E4A9",
    addr: "0xdd974D5C2e2928deA5F71b9825b8b646686BD200",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4b4e432d41000000000000000000000000000000000000000000000000000000",
  },
  "MANA-A": {
    token: "MANA",
    ratio: 4 / 7,
    joinAddr: "0xA6EA3b9C04b8a38Ff5e224E7c3D6937ca44C0ef9",
    addr: "0x0F5D2fB29fb7d3CFeE444a200298f468908cC942",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4d414e412d410000000000000000000000000000000000000000000000000000",
  },
  "USDT-A": {
    token: "USDT",
    ratio: 2 / 3,
    joinAddr: "0x0Ac6A1D74E84C2dF9063bDDc31699FF2a2BB22A2",
    addr: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x555344542d410000000000000000000000000000000000000000000000000000",
  },
  "PAXUSD-A": {
    token: "PAX",
    ratio: 5 / 6,
    joinAddr: "0x7e62B7E279DFC78DEB656E34D6a435cC08a44666",
    addr: "0x8E870D67F660D95d5be530380D0eC0bd388289E1",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x5041585553442d41000000000000000000000000000000000000000000000000",
  },
  "TUSD-A": {
    token: "TUSD",
    ratio: 5 / 6,
    joinAddr: "0x4454aF7C8bb9463203b66C816220D41ED7837f44",
    addr: "0x0000000000085d4780B73119b644AE5ecd22b376",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x545553442d410000000000000000000000000000000000000000000000000000",
  },
  "COMP-A": {
    token: "COMP",
    ratio: 4 / 7,
    joinAddr: "0xBEa7cDfB4b49EC154Ae1c0D731E4DC773A3265aA",
    addr: "0xc00e94Cb662C3520282E6f5717214004A7f26888",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x434f4d502d410000000000000000000000000000000000000000000000000000",
  },
  "LINK-A": {
    token: "LINK",
    ratio: 4 / 7,
    joinAddr: "0xdFccAf8fDbD2F4805C174f856a317765B49E4a50",
    addr: "0x514910771AF9Ca656af840dff83E8264EcF986CA",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4c494e4b2d410000000000000000000000000000000000000000000000000000",
  },
  "LRC-A": {
    token: "LRC",
    ratio: 4 / 7,
    joinAddr: "0xBBbbCA6A901c926F240b89EacB641d8Aec7AEafD",
    addr: "0x6C186404A7A238D3d6027C0299D1822c1cf5d8f1",
    stabiltyRate: 0,
    price: 0,
    typeBytes:
      "0x4c52432d41000000000000000000000000000000000000000000000000000000",
  },
};

module.exports = class Maker {
  /**
   * @param {Object} _dsa the dsa instance to access data stores
   */
  constructor(_dsa) {
    this.ABI = _dsa.ABI;
    this.address = _dsa.address;
    this.tokens = _dsa.tokens;
    this.web3 = _dsa.web3;
    this.math = _dsa.math;
    this.dsa = _dsa;
    this.colInfo = colInfo;
  }

  calRate(ilkRate) {
    ilkRate = Number(ilkRate) / 10 ** 27;
    return ilkRate ** 31545000 - 1;
  }

  /**
   * get properly formatted compound position details
   * @param {string} address the owner address
   * @param {string} cTokens the cToken address
   */
  async getVaults(address) {
    var _address;
    !address ? (_address = this.instance.address) : (_address = address);
    var _obj = {
      protocol: "maker",
      method: "getVaults",
      args: [_address],
    };
    return new Promise(async (resolve, reject) => {
      await this.dsa
        .read(_obj)
        .then((res) => {
          var _userVaults = res;
          var userVaults = {};
          for (var i = 0; i < _userVaults.length; i++) {
            var _id = _userVaults[i][0];
            userVaults[_id] = {};
            userVaults[_id].owner = _userVaults[i][1];
            userVaults[_id].colName = _userVaults[i][2];
            userVaults[_id].token = this.colInfo[_userVaults[i][2]].token;
            var _col = this.math.divWithDec(_userVaults[i][3], 18);
            userVaults[_id].col = _col;
            var _debt = this.math.divWithDec(_userVaults[i][5], 18);
            userVaults[_id].debt = _debt;
            userVaults[_id].liquidatedCol = this.math.divWithDec(
              _userVaults[i][6],
              18
            );
            userVaults[_id].rate = this.calRate(_userVaults[i][7]) * 100;
            var _price = this.math.divWithDec(_userVaults[i][8], 27);
            userVaults[_id].price = _price;
            userVaults[_id].status = _debt / (_col * _price);
            userVaults[_id].liquidation =
              1 / this.math.divWithDec(_userVaults[i][9], 27);
            userVaults[_id].urn = _userVaults[i][10];
          }
          resolve(userVaults);
        })
        .catch((err) => {
          reject(err);
        });
    });
  }

  async getCollateralInfo() {
    var _obj = {
      protocol: "maker",
      method: "getColInfo",
      args: [Object.keys(this.colInfo)],
    };

    return new Promise(async (resolve, reject) => {
      await this.dsa
        .read(_obj)
        .then((res) => {
          var _colInfo = {};
          Object.keys(this.colInfo).forEach((_col, i) => {
            _colInfo[_col] = {};
            _colInfo[_col].token = this.colInfo[_col].token;
            _colInfo[_col].rate = this.calRate(res[i][0]) * 100; // in percent
            _colInfo[_col].price = res[i][1] / 1e27;
            _colInfo[_col].ratio = 1 / (res[i][2] / 1e27);
            _colInfo[_col].debtCeiling = Number(res[i][3]);
            _colInfo[_col].totalDebt = res[i][4] / 1e18;
          });
          resolve(_colInfo);
        })
        .catch((err) => {
          reject(err);
        });
    });
  }

  async getDaiPosition(address) {
    var _obj = {
      protocol: "maker",
      method: "getDaiPosition",
      args: [address],
    };

    return new Promise(async (resolve, reject) => {
      await this.dsa
        .read(_obj)
        .then((res) => {
          var _dsrInfo = {
            balance: res[0] / 1e18,
            rate: this.calRate(res[1]),
          };
          resolve(_dsrInfo);
        })
        .catch((err) => {
          reject(err);
        });
    });
  }

  async getDaiRate() {
    var _obj = {
      protocol: "maker",
      method: "getDsrRate",
      args: [],
    };

    return new Promise(async (resolve, reject) => {
      await this.dsa
        .read(_obj)
        .then((res) => {
          resolve({ rate: this.calRate(res) });
        })
        .catch((err) => {
          reject(err);
        });
    });
  }
};
